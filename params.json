{"name":"Safecast bGeigie","tagline":"Firmware for the bGeigie device developed by Safecast","body":"# Safecast bGeigie Library\r\n\r\nSafecastBGeigie is the code for the firmware needed to run the bGeigie devices\r\nfrom Safecast. The necessary building blocks such as SD card logger, GPS\r\nparser, power management, etc, are included in the form of an Arduino library.\r\nThe firmwares for the different devices are given as examples of this library.\r\n\r\n# bGeigie NX\r\n\r\n## Data log file format\r\n\r\nThe data is formatted similarly to NMEA sentences that GPS uses. It always starts with a `$`\r\nand ends with a `*`. Following the star is a checksum. \r\n\r\n### Radiation data sentence\r\n\r\nThis is the basic message containing the geo-located radiation measurement.\r\n\r\nExample:\r\n\r\n    $BNXRDD,300,2012-12-16T17:58:24Z,31,9,115,A,4618.9996,N,00658.4623,E,587.6,A,3,77.2,1*1A\r\n    $BNXRDD,300,2012-12-16T17:58:31Z,30,1,116,A,4618.9612,N,00658.4831,E,443.7,A,5,1.28,1*1D\r\n    $BNXRDD,300,2012-12-16T17:58:36Z,32,4,120,A,4618.9424,N,00658.4802,E,428.1,A,6,1.27,1*18\r\n    $BNXRDD,300,2012-12-16T17:58:41Z,32,2,122,A,4618.9315,N,00658.4670,E,425.5,A,6,1.27,1*1B\r\n    $BNXRDD,300,2012-12-16T17:58:46Z,34,3,125,A,4618.9289,N,00658.4482,E,426.0,A,6,1.34,1*13\r\n\r\n0. Header : BNXRDD\r\n1. Device ID : Device serial number. `300`\r\n2. Date : Date formatted according to iso-8601 standard. Usually uses GMT. `2012-12-16T17:58:31Z`\r\n3. Radiation 1 minute : number of pulses given by the Geiger tube in the last minute. `30`\r\n4. Radiation 5 seconds : number of pulses given by the Geiger tube in the last 5 seconds. `1`\r\n5. Radiation total count : total number of pulses recorded since startup. `116`\r\n6. Radiation count validity flag : 'A' indicates the counter has been running for more than one minute and the 1 minute count is not zero. Otherwise, the flag is 'V' (void). `A`\r\n7. Latitude : As given by GPS. The format is `ddmm.mmmm` where `dd` is in degrees and `mm.mmmm` is decimal minute. `4618.9612`\r\n8. Hemisphere : 'N' (north), or 'S' (south). `N`\r\n9. Longitude : As given by GPS. The format is `dddmm.mmmm` where `ddd` is in degrees and `mm.mmmm` is decimal minute. `00658.4831`\r\n10. East/West : 'W' (west) or 'E' (east) from Greenwich. `E`\r\n11. Altitude : Above sea level as given by GPS in meters. `443.7`\r\n12. GPS validity : 'A' ok, 'V' invalid. `A`\r\n13. Number of Satellites : Number of satellites in view. `5`\r\n14. HDOP : Horizontal Dilution of Precision (HDOP), relative accuracy of horizontal position. `1.28`\r\n15. Fix Quality : 0 = invalid, 1 = GPS Fix, 2 = DGPS Fix. `1`\r\n16. Checksum. `*1D`\r\n\r\n### Device status sentence\r\n\r\nThis is an extra sentence containing information about the sensor status.\r\n\r\nExample:\r\n\r\n    $BNXSTS,300,2012-12-16T17:58:24Z,4618.9996,N,00658.4623,E,v3.0.3,22,49,3987,,1,1,1*7D\r\n    $BNXSTS,300,2012-12-16T17:58:31Z,4618.9612,N,00658.4831,E,v3.0.3,22,50,3987,,1,1,1*7F\r\n    $BNXSTS,300,2012-12-16T17:58:36Z,4618.9424,N,00658.4802,E,v3.0.3,22,50,3987,,1,1,1*7F\r\n    $BNXSTS,300,2012-12-16T17:58:41Z,4618.9315,N,00658.4670,E,v3.0.3,22,50,3987,,1,1,1*71\r\n    $BNXSTS,300,2012-12-16T17:58:46Z,4618.9289,N,00658.4482,E,v3.0.3,22,49,3987,,1,1,1*75\r\n\r\n0. Header : BNXSTS\r\n1. Device ID : Device serial number. `300`\r\n2. Date : Date formatted according to iso-8601 standard. Usually uses GMT. `2012-12-16T17:58:24Z`\r\n3. Latitude : As given by GPS. The format is `ddmm.mmmm` where `dd` is in degrees and `mm.mmmm` is decimal minute. `4618.9996`\r\n4. Hemisphere : 'N' (north), or 'S' (south). `N`\r\n5. Longitude : As given by GPS. The format is `dddmm.mmmm` where `ddd` is in degrees and `mm.mmmm` is decimal minute. `00658.4623`\r\n6. East/West : 'W' (west) or 'E' (east) from Greenwich. `E`\r\n7. Firmware version number. `v3.0.3`\r\n8. Temperature in degree Celsius.\r\n9. Relative humidity in %.\r\n10. Battery voltage in millivolts.\r\n11. High voltage in volts, if available. Empty otherwise.\r\n12. SD inserted status. 1=present, 0=missing.\r\n13. SD initialization status. 1=ok, 0=failed.\r\n14. SD last write status. 1 = ok, 0 = last write failed.\r\n15. Checksum. `*7D`\r\n\r\n### Checksum computation\r\n\r\nThe checksum is a XOR of all the ASCII characters bytes between '$' and '\\*' (these excluded).\r\nSample C code to compute the checksum is given.\r\n\r\n    /* Compute checksum of input array */\r\n    char GPS_checksum(char *s, int N) \r\n    {             \r\n      int i = 0;  \r\n      char chk = s[0];\r\n\r\n      for (i=1 ; i < N ; i++)                                                                \r\n        chk ^= s[i];\r\n\r\n      return chk;\r\n    } \r\n\r\nThe checksum is then always encoded as a string of two ASCII characters giving the hexadecimal value of the checksum.\r\n\r\n## Setup System on Mac OS X\r\n\r\n### Software\r\n\r\n* Patched Arduino IDE [download](https://github.com/downloads/fakufaku/Arduino/arduino-Safecast-20121019-macosx.zip)\r\n* CrossPack for AVR [download](http://www.obdev.at/products/crosspack/index-de.html)\r\n* FTDI USB-Serial drivers [x64](http://www.ftdichip.com/Drivers/VCP/MacOSX/FTDIUSBSerialDriver_v2_2_18.dmg) [x86](http://www.ftdichip.com/drivers/VCP/MacOSX/FTDIUSBSerialDriver_v2_2_18.dmg) \r\n  [PPC](http://www.ftdichip.com/Drivers/VCP/MacOSX/FTDIUSBSerialDriver_v2_2_18.dmg)\r\n\r\n### Libraries\r\n\r\n* SafecastBGeigie (this library), use branch `NextGeneration` [download](https://github.com/Safecast/SafecastBGeigie/zipball/NextGeneration) \r\n* chibiArduino modified to use with Atmega1284p (included with patched Arduino IDE) [download](https://github.com/fakufaku/chibiArduino)\r\n* CmdArduino (included with patched Arduino IDE) [download](https://github.com/fakufaku/CmdArduino)\r\n* Mighty 1284p core files (included with patched Arduino IDE) [download](https://github.com/fakufaku/mighty-1284p)\r\n* [Option] SparkFun's Pro Micro core files, if you want to use the Atmega32u4 with a bootloader [download](http://dlnmh9ip6v2uc.cloudfront.net/datasheets/Dev/Arduino/Boards/ProMicro-Addon-190612.zip)\r\n\r\n### Hardware\r\n\r\n* FTDI breakout board *3.3V*, for example this [one](https://www.sparkfun.com/products/9873) or this [one](https://www.adafruit.com/products/284)\r\n* USB male A to male mini B cable such as this [one](https://www.adafruit.com/products/260)\r\n* A [Pocket AVR Programmer](https://www.sparkfun.com/products/9825) from SparkFun. [Using another programmer type than USBTiny type requires editing a makefile.]\r\n* A bGeigie2 board. The [PCB design files](https://github.com/Safecast/bGeigie2) are available under CC-BY-SA 3.0 license.\r\n\r\n## Install\r\n\r\n### Environment\r\n\r\n1. [Download](http://www.obdev.at/products/crosspack/index-de.html) and install the CrossPack for AVR toolchain.\r\n2. [Download](https://github.com/downloads/fakufaku/Arduino/arduino-Safecast-20121019-macosx.zip) and install Patched Arduino IDE Arduino's website provides help [getting started](http://arduino.cc/en/Guide/MacOSX), if needed.\r\n3. [Download](https://github.com/Safecast/SafecastBGeigie/zipball/NextGeneration) and install SafecastBGeigie library in the Arduino library folder. [Arduino libraries help](http://arduino.cc/en/Guide/Libraries).\r\n\r\n### Upload bootloader to main microcontroller\r\n\r\n1. Launch the Arduino-Safecast IDE\r\n2. Connect Pocket AVR Programmer to the ISP Pin header. Pin 1 of the ISP is marked on the PCB. Make sure the switch on the programmer is set to `No power`. Make sure the battery it attached to the board and has some charge. Make sure no SD card is inserted.\r\n  ![ISP setting](https://dl.dropbox.com/u/78009186/Photos/bGeigie3/isp_setting.jpg)\r\n3. Pull low (off) the left switch on the small black dual switch on the board.\r\n  ![Switch Setting 1284p](https://dl.dropbox.com/u/78009186/Photos/bGeigie3/program_1284p.jpg)\r\n4. In Arduino IDE, select `Tools -> Programmer -> USBtinyISP`, and `Tools -> Board -> Mighty 1284p 8MHz using Optiboot`. Finally `Tools -> Burn Bootloader`.\r\n5. Pull back up the left small switch. Both switches should be up (on) now.\r\n  ![Switch normal mode](https://dl.dropbox.com/u/78009186/Photos/bGeigie3/normal_setting.jpg)\r\n\r\n### Upload USB controller firmware\r\n\r\n1. Launch the Arduino-Safecast IDE\r\n2. Connect Pocket AVR Programmer to the ISP Pin header. Pin 1 of the ISP is marked on the PCB. Make sure the switch on the programmer is set to `No power`. Make sure the battery it attached to the board and has some charge. Make sure no SD card is inserted.\r\n  ![ISP setting](https://dl.dropbox.com/u/78009186/Photos/bGeigie3/isp_setting.jpg)\r\n3. Pull low (off) the small switch on the right of the black dual switch.\r\n  ![Switch Setting 32u4](https://dl.dropbox.com/u/78009186/Photos/bGeigie3/program_32u4.jpg)\r\n4. In a terminal, go to `SDReader32u4/MassStorage`.\r\n\r\n        cd <arduino_libraries_path>/SDReader32u4/MassStorage\r\n\r\n5. Compile and upload SD reader firmware to USB microcontroller. If not using a USBtinyISP kind of AVR programmer, the makefile needs to be modified before this step.\r\n\r\n        make avrdude\r\n\r\n6. Pull back up the left small switch. Both switches should be up (on) now.\r\n  ![Switch normal mode](https://dl.dropbox.com/u/78009186/Photos/bGeigie3/normal_setting.jpg)\r\n\r\n### Upload bGeigie3 firmware\r\n\r\n1. Launch the Arduino-Safecast IDE\r\n2. Plug the FTDI breakout board on the board as shown on the picture.\r\n  [picture]\r\n3. Select Serial port corresponding to FTDI breakout board from `Tools -> Serial Port -> [my port]`.\r\n4. Open the bGeigie3 sketch from menu `Examples->SafecastBGeigie->bGeigie3`.\r\n5. Press upload button (or `File -> Upload`).\r\n6. Open the Serial terminal by pressing button (or `Tools -> Serial Monitor`), you should see something like\r\n\r\n        *** Welcome to bGeigie ***\r\n        Version-3.0.1\r\n        GPS start time,590ms\r\n        --- Diagnostic START ---\r\n        Version,3.0.1\r\n        Device ID,300\r\n        Radio initialized,yes\r\n        Radio address,3300\r\n        Radio channel,20\r\n        GPS type MTK,yes\r\n        GPS system startup,yes\r\n        SD inserted,yes\r\n        SD initialized,yes\r\n        SD open file,yes\r\n        SD read write,yes\r\n        SD reader initialized,yes\r\n        Temperature,24C\r\n        Humidity,49%\r\n        Battery voltage,3827mV\r\n        System free RAM,13507B\r\n        --- Diagnostic END ---\r\n        Starting now!\r\n        bGeigie sleeps... good night.\r\n\r\n    Congratulations, we're half-way there.\r\n\r\n## Example Sketches\r\n\r\nThe sketches given in examples are the actual firmware of the different Safecast bGeigie devices:\r\n\r\n* bGeigieMini\r\n* bGeigieClassic\r\n* bGeigieNinja\r\n* bGeigieConfigBurner\r\n* SlidingWindowCounter\r\n\r\n## License\r\n\r\n    Copyright (c) 2011-2012, Robin Scheibler aka FakuFaku, Christopher Wang aka Akiba\r\n    All rights reserved.\r\n\r\n    Redistribution and use in source and binary forms, with or without\r\n    modification, are permitted provided that the following conditions are met:\r\n\r\n    1. Redistributions of source code must retain the above copyright\r\n       notice, this list of conditions and the following disclaimer.\r\n    2. Redistributions in binary form must reproduce the above copyright\r\n       notice, this list of conditions and the following disclaimer in the\r\n       documentation and/or other materials provided with the distribution.\r\n    3. Neither the name of the <organization> nor the\r\n       names of its contributors may be used to endorse or promote products\r\n       derived from this software without specific prior written permission.\r\n\r\n    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n    ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n    WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n    DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR ANY\r\n    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n    (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n    LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n    SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n\r\n## Acknowledgement\r\n\r\n* [Bunnie Huang](http://www.bunniestudios.com/) for a lot of help and patience helping setting up the production.\r\n* [Freaklabs](http://freaklabs.org/) for a lot of help in general, and more particularly for the design of the radio and the great [chibiArduino](http://www.freaklabs.org/index.php/chibiArduino.html) library for 802.15.4 communication.\r\n* [Maniacbug](http://maniacbug.wordpress.com/2011/11/27/arduino-on-atmega1284p-4/) for his port of the arduino environment for the Atmega1284p that got me started.\r\n* [ElasticSheep](http://elasticsheep.com/2010/04/teensy2-usb-mass-storage-with-an-sd-card/) for the basis of the SD mass storage reader.\r\n* [LUFA](http://www.fourwalledcubicle.com/LUFA.php) for the SD mass storage reader.\r\n* [Adafruit](http://www.adafruit.com/) for the design around the Atmega32U4 inspired from their [breakout board](https://www.adafruit.com/products/296).\r\n* [SparkFun](https://www.sparkfun.com) for the Li-Poly charger inspired by their [basic charger](https://www.sparkfun.com/products/10401).\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}